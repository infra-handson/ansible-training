Start - [1](step1.md) - [2](step2.md) - [3](step3.md) - [4](step4.md) - [5](step5.md) - [6](step6.md) - [**7**](step7.md) - [8](step8.md) - End


# 課題6: 条件分岐の使い方の応用

## 課題6-1: 実行確認用のタスクを作成する

ユーザ確認をアドホックコマンドで行っていましたが、これを`shell`モジュールを使ってタスクとして作成してください。  
ただし、確認結果は変数と`when`を使って出力有無を制御できるようにしてください。  
なお、このタスクは毎回`changed`と出力されてしまってもよいものとします。

### 補足1

実行時のみ特定の変数を定義したい場合は以下のように`-e`オプションを使って行えます。  
`-e`は`extra-vars`と呼ばれるオプションで、無計画に使用するとコードでの状態管理が行えなくなるリスクがありますが、今回のような用途として使うと便利に使うことができます。  
具体的には以下のように実行します。

```bash
# user_checkという名前の変数にTrueを定義して実行する
ansible-playbook -i inventory <Playbookファイル> -e "user_check=True"
```

### 補足2

モジュールの実行結果は最低限しか出力されず、`shell`モジュールの場合は`changed`としか出力されません。  
具体的な実行結果を出力したい場合は`register`と`debug`を使い、以下のように記述します。  
この使い方はデバッグを行う際にもよく使うため、知っておくとよいです。

```yaml
- name: "コマンドの実行"
  shell: "hostname"
  register: ret  # これを記載するとモジュールの結果がret変数に格納される

- name: "コマンド実行結果の出力"
  debug:
    msg: "{{ ret.stdout_lines }}"
```

上記のコードを実行すると以下のように出力されます。

```text
TASK [common : コマンドの実行] ********************************************************************************************************************************************************************************************************************************************************************************
changed: [target01]
changed: [target02]

TASK [common : コマンド実行結果の出力] ****************************************************************************************************************************************************************************************************************************************************************************
ok: [target02] => {
    "msg": [
        "target-server-02"
    ]
}
ok: [target01] => {
    "msg": [
        "target-server-01"
    ]
}
```

---

- [前のページに戻る](step6a.md)
- [目次](README.md)
- [次のページに進む](step8.md)
