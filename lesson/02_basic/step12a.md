# 課題6-2-回答: モジュールに存在しない処理の冪等性を考える

`roles/kadai-6-2/tasks/main.yaml`  
※コメントを記載している部分が課題6-1の回答例から追加したコードになります。

```yaml
# 新たに追加したタスク
- name: ファイル内容を確認する
  ansible.builtin.shell:
    cmd: cat ~/resultfile
  register: cat_resultfile  # タスクの実行結果を変数に登録する
  ignore_errors: true       # タスクが異常終了しても無視して後続タスクを実行する
  changed_when: false       # 正常終了してもchangedにしない

# 新たに追加したデバッグタスク。コーディング、デバックが完了したら動作させない
- name: 変数stat_resultfileの内容を確認
  ansible.builtin.debug:
    var: cat_resultfile

- name: シェルコマンドを実行するタスク
  shell: hostname >> ~/resultfile
  when: 
    - cat_resultfile.stdout != server_hostname  # registerで登録した値を冪等性を保つための条件に使う
```

ポイント

* ファイルの内容をタスクの実行条件にしている
  * 変数`cat_resultfile`にファイル`~/resultfile`の内容を格納する
    * ファイルが未作成の状態ではコマンドがエラーになる。タスクが異常終了すると後続タスクが実行されないため`ignore_errors: true`でエラーを無視して後続タスクが実行されるようにしている
    * `shell`モジュールはコマンドが成功すると`changed`になる。catコマンドでは何も変更しないため`changed_when: false`で`changed`にならないようにしている
  * 変数`cat_resultfile`の内容を確認する
    * `cat_resultfile`の要素名と値を確認してコマンド実行結果の標準出力が格納る要素を確認している
    * これはコーディング時にだけ必要なため、動作確認が完了したら削除する。
    * 削除しないと不要なログが出力される。
  * タスク実行に条件を追加する
    * ファイルの内容がホスト名ではない場合のみタスクを実行する

## 本課題の出題意図

ほとんどのモジュールはシェルコマンドを組み合わせることで実現可能なため、shellモジュールのみでPlaybookを実装することも可能です。  
しかし、今回の課題でわかるようにshellモジュールでの実装は冪等性が担保されないため、ユーザが冪等性を担保するタスク実装を行わければなりません。  
結果として、コードが複雑になったりバグが埋め込まれてしまうなどの問題が発生する可能性が高くなってしまいます。  
既存モジュールで用意されていない処理を行う必要がある自動化は概して作成や保守の難易度が高くなってしまうということを理解しておいてください。

---

- [前のページに戻る](step12.md)
- [目次](README.md)

