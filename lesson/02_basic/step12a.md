# 課題6-2-回答: モジュールに存在しない処理の冪等性を考える

`roles/kadai-6-2/tasks/main.yaml`  
※コメントを記載している部分が課題6-1の回答例から追加したコードになります。

```yaml
# 新たに追加したタスク
- name: 冪等性を保つための確認
  stat:
    path: ~/resultfile
  register: stat_resultfile  # タスクの実行結果を変数に登録する

- name: シェルコマンドを実行するタスク
  shell: hostname >> ~/resultfile
  when:
    - not stat_resultfile.stat.exists  # registerで登録した値を冪等性を保つための条件に使う
```

ポイント

* 今回のshellモジュールで実行したい処理は特定のファイル作成を行う処理なため、ファイルの有無をタスクの実行条件にしている
  * 様々な状況を考慮するとこれだけでは不十分だが、今回はシンプルな実装で済ませている
  * 例えば、`resultfile`の中身が別の文字列になっていた場合もskippingになってしまうなどの問題が考えられる

## 本課題の出題意図

ほとんどのモジュールはシェルコマンドを組み合わせることで実現可能なため、shellモジュールのみでPlaybookを実装することも可能です。  
しかし、今回の課題でわかるように、shellモジュールでの実装は冪等性が担保されないため、ユーザ側で冪等性を担保する実装を行わければなりません。  
その結果として、コードが複雑になったり、バグが埋め込まれてしまうなどの問題が発生する可能性が高くなってしまいます。  
このような理由から、既存モジュールで用意されていない処理を行う必要がある自動化は概して作成や保守の難易度が高くなってしまうということを認識しておくとよいです。

---

- [前のページに戻る](step12.md)
- [目次](README.md)

